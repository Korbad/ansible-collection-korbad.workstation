- set_fact:
    microcode_paths:
      - /intel-ucode.img
      - /amd-ucode.img

- name: Check if microcode files exist
  stat:
    path: "{{ esp_mount_path }}{{ item }}"
  register: microcode_stat_result
  loop: "{{ microcode_paths }}"
  become: true

- name: Fail if a microcode file is missing
  fail:
    msg: "The file {{ item.item }} is missing!"
  when: not item.stat.exists
  loop: "{{ microcode_stat_result.results }}"