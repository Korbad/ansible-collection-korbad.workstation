- name: Create CRI-O configuration directory
  ansible.builtin.file:
    path: "/home/{{ ansible_env.USER }}/.config/crio"
    state: directory
    owner: "{{ ansible_env.USER }}"
    mode: "0700"
  become: true

- name: Configure CRI-O for rootless mode
  ansible.builtin.template:
    src: templates/crio-rootless.conf.j2
    dest: "/home/{{ ansible_env.USER }}/.config/crio/crio.conf"
    owner: "{{ ansible_env.USER }}"
    mode: "0600"
  become: true

- name: Create CRI-O service override directory
  ansible.builtin.file:
    path: /etc/systemd/system/crio.service.d
    state: directory
    mode: "0755"
  become: true

- name: Create CRI-O service override file
  ansible.builtin.file:
    path: /etc/systemd/system/crio.service.d/override.conf
    state: touch
    mode: "0644"
    owner: root
    group: root
  become: true

- name: Set CRI-O service user
  ansible.builtin.lineinfile:
    path: /etc/systemd/system/crio.service.d/override.conf
    regexp: '^User='
    line: 'User={{ ansible_env.USER }}'
  become: true
  notify: reload systemd daemon
  changed_when: true

- name: Start CRI-O service
  ansible.builtin.service:
    name: crio.service
    state: started
    enabled: true
    daemon_reload: yes
  become: true
