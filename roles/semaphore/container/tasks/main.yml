# Alternative for AWX ansible
# To access, go to http://localhost:3000

# - name: Return the logged-in user for docker hub registry
#   containers.podman.podman_login_info:
#     registry: docker.io

- name: Pull an Ansible semaphore image
  containers.podman.podman_image:
    name: docker.io/ansiblesemaphore/semaphore:latest

- name: Pull an MariaDB image
  containers.podman.podman_image:
    name: docker.io/mariadb
    tag: "{{mariadb_version}}"

- name: Create an ansible pod
  containers.podman.podman_pod:
    name: ansible
    state: started
    ports:
      - "{{ semaphore_exposed_db_port }}:3306"
      - "{{ semaphore_exposed_http_port }}:3000"

- name: Ensure Maria DB volume exists
  containers.podman.podman_volume:
    name: semaphore_mariadb_volume

- name: Run MariaDB container
  containers.podman.podman_container:
    name: mariadb
    image: "mariadb:{{mariadb_version}}"
    pod: ansible
    volumes:
      - semaphore_mariadb_volume:/var/lib/mysql
    env:
      MYSQL_ROOT_PASSWORD: "{{semaphore_db_root_password}}"
      MYSQL_DATABASE:      "semaphore" 
      MYSQL_USER:          "test_semaphore"
      MYSQL_PASSWORD:      "{{semaphore_db_auth_password}}"
    state: started

- name: Ensure Semaphore data volume exists
  containers.podman.podman_volume:
    name: semaphore_data_volume

- name: Run Sempahohe container
  containers.podman.podman_container:
    name: semaphore
    image: docker.io/semaphoreui/semaphore
    pod: ansible
    requires: mariadb
    volumes:
      - semaphore_data_volume:/opt/data/semaphore
    env:
      SEMAPHORE_DB_USER:        "test_semaphore"
      SEMAPHORE_DB_PASS:        "{{ semaphore_db_auth_password }}" 
      SEMAPHORE_DB_HOST:        "127.0.0.1"
      SEMAPHORE_DB_PORT:        "{{ semaphore_exposed_db_port }}"
      SEMAPHORE_DB:             "semaphore"
      SEMAPHORE_PLAYBOOK_PATH:  "/etc/semaphore"
      SEMAPHORE_ADMIN_PASSWORD: "{{semaphore_password}}"
      SEMAPHORE_ADMIN_NAME:     "Maintainer"
      SEMAPHORE_ADMIN_EMAIL:    "admin@localhost"
      SEMAPHORE_ADMIN:          "admin"
      SEMAPHORE_WEB_ROOT:       "http://localhost:{{ semaphore_exposed_http_port }}"
    state: started