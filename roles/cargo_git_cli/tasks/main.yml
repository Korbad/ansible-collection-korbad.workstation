- name: Check if .cargo/config exists
  stat:
    path: "{{ cargo_config_file_path }}"
  register: cargo_config_stat

- name: Modify .cargo/config if it exists to add the [net] category
  ansible.builtin.lineinfile:
    path: "{{ cargo_config_file_path }}"
    line: "[net]"
    insertbefore: EOF
    state: present
  when: cargo_config_stat.stat.exists

- name: Modify .cargo/config if it exists
  ansible.builtin.lineinfile:
    path: "{{ cargo_config_file_path }}"
    line: "git-fetch-with-cli = true"
    insertafter: "\\[net\\]"
    state: present
  when: cargo_config_stat.stat.exists

- name: Create .cargo/config if it doesn't exist
  ansible.builtin.template:
    src: templates/cargo-config.j2
    dest: "{{ cargo_config_file_path }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0644
  when: not cargo_config_stat.stat.exists