---
- name: Set minikube rootless
  ansible.builtin.command:
    cmd: minikube config set rootless true
  register: set_rootless_result
  changed_when: "'These changes will take effect upon a minikube delete and then a minikube start' in set_rootless_result.stdout"

- name: Set minikube driver
  ansible.builtin.command:
    cmd: minikube config set driver podman
  register: set_driver_result
  changed_when: "'These changes will take effect upon a minikube delete and then a minikube start' in set_driver_result.stdout"

- name: Set container-runtime for Minikube
  ansible.builtin.command:
    cmd: minikube config set container-runtime cri-o
  register: set_container_runtime_result
  changed_when: "'These changes will take effect upon a minikube delete and then a minikube start' in set_container_runtime_result.stdout"

- name: Check if Minikube is already started
  ansible.builtin.command:
    cmd: minikube status
  register: minikube_status_result
  changed_when: false
  failed_when: false

- debug:
    var: minikube_status_result

- meta: end_play

- name: Start Minikube cluster
  shell: minikube start --cpus=4 --memory=6g --addons=ingress
  register: start_minikube_status
  when: "'host: Running' not in minikube_status_result.stdout"