---
- name: Check if settings.json exists
  stat:
    path: "{{ code_oss_config_path }}"
  register: settings_json_stat

- name: Launch code if settings.json does not exist
  command: code
  args:
    creates: "{{ code_oss_config_path }}"
  when: not settings_json_stat.stat.exists

- name: Wait for settings.json to be created
  wait_for:
    path: "{{ code_oss_config_path }}"
    state: present
  when: not settings_json_stat.stat.exists

- name: slurp settings.json
  slurp:
    path: "{{ code_oss_config_path }}"
  register: slurp_json

- name: update code_oss settings.json
  copy:
    dest: "{{ code_oss_config_path }}"
    content: "{{ code_oss_configuration | to_nice_json }}"
    remote_src: true
  vars:
    code_oss_current_config: "{{ slurp_json.content | b64decode | from_json }}"
    code_oss_configuration: "{{ code_oss_current_config | default({}, true) | combine(managed_code_oss_settings_dict)}}"
  when: managed_code_oss_settings_dict is defined
